---
title: "Clase modelos"
subtitle: "Modelos mixtos"
author: "Miriam Lerma"
date: "Mayo 2021"
output:
  xaringan::moon_reader:
    css: RZero-themer.css
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: true
      
---

```{r metathis, include = FALSE}
#Con esta libreria puedo poner informacion que saldra en el titulo, en los buscadores y demas, como de titulo y fechas. Asi como elegir la imagen que saldra de inicio.

library(metathis)
meta() %>%
  meta_name("github-repo" = "MiriamLL/Curso_CIAD") %>%
  meta_social(
    title = "Cargar datps",
    description = paste0(
      "Introduccion a RStudio",
      "Curso de R"),
    url = "https://github.com/MiriamLL/Curso_CIAD/blob/main/Clase3Parte1.html",
    image_alt = paste0(
      "Introduccion a R y RStudio",
      "Curso de R"),
    og_type = "website",
    og_author = "Miriam Lerma",
    twitter_card_type = "summary_large_image",
    twitter_creator = "@MiriamLL",
    twitter_site = "@MiriamLL")
```

```{r include = FALSE}
#Paquetes
library(xaringanExtra)
ColorLink<-"#f2cc8f"
```

```{r xaringan-panelset, echo=FALSE}
xaringanExtra::use_panelset()
``` 

```{r, echo=FALSE,include=FALSE, message=FALSE}
library(emo)
library(here)
library(fontawesome)
library(ggplot2)
```

class: title-slide, inverse, middle, right
background-image: url(https://images.unsplash.com/photo-1602264419088-8f8c7ab48489?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=1267&q=80)
background-size: cover

### `r rmarkdown::metadata$title`
# `r rmarkdown::metadata$subtitle`

## `r rmarkdown::metadata$author`<br>
`r rmarkdown::metadata$date`

---

class: inverse

# Intro
- [Modelos mixtos](#lmer)
- [Incluir efectos aleatorios](#random_effects)
- [Incluir efectos anidados](#nested_effects)
- [AIC](#AIC)
- [Comparar modelos](#comparar)

--

#### Ustedes

- Conocimientos de R (saben abrirlo, cargar paquetes y datos, saben hacer operaciones y gr치ficos).  
- Quieren crear modelos mixtos en R y conocer la sintaxis. 
La clase de hoy esta en el [repositorio](https://github.com/MiriamLL/Prueba)
Clonen/Descarguen los materiales.  

#### Preguntas
Responder en el chat 游눫
- Han visto modelos mixtos en art칤culos o tesis?
- Alguien ha escuchado que es el AIC?

---
class: inverse

## Cr칠ditos & Recursos

Lecturas
- [`r fa("book-open", fill = ColorLink)` Intro por Gabriela Hajduk](https://gkhajduk.github.io/2017-03-09-mixed-models/)
- [`r fa("book-open", fill = ColorLink)` Introduccion](https://athanasiamo.github.io/LME_introduction_workshop/slides/lme_rladies_london.html#1)<br>

Videos en espa침ol
- [`r fa("youtube", fill = ColorLink)` Modelos mixtos por Sara Acevedo](https://vimeo.com/526381086)<br>

En ingles  
- [`r fa("youtube", fill = ColorLink)` Video explicando Teor칤a](https://www.youtube.com/watch?v=sdYKtsmtXmc&list=PLVlVXU7jGfm1seY4xxINrsp23AmrYFYa7&index=4)
- [`r fa("book-open", fill = ColorLink)` mixed-models with R Michel Clark](https://m-clark.github.io/mixed-models-with-R/#)

Imagenes
- Portada  
[Unsplash by Ilse Orsel](https://unsplash.com/@lgtts)  


---

name: repro
class: center, middle, inverse

# 1. Modelos lineares mixtos

---

## 1.1. Intro

Modelos lineales:  
- Errores aleatorios independientes
- Errores aleatorios siguen una distribuci칩n normal

Modelos lineales mixtos
- Incorpora efectos aleatorios para acomodar la correlaci칩n entre las observaciones 
- Condicionado a los efectos aleatorios, los errores aleatorios son independientes con  varianza constante 
- Errores aleatorios con distribuci칩n normal
- Efectos aleatorios con distribuci칩n normal 
- Efectos aleatorios y errores aleatorios son independientes 


---

## 1.1. Intro

쯇orque usarlos?

- Datos pueden presentar heterogeneidad
- Por ejemplo: pueden estar agrupados por provenir de diferentes 치reas, o presentar medidas repetidas
- Medidas repetidas induce a una estructura de correlaci칩n, que si no se considera puede llevar a estimaciones sesgadas
- Afectando las predicciones y por lo tanto las decisiones basadas en esos datos


---
name: lmer

## 2.2. Datos

Paquetes a cargar para leer los datos
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
library(readr)
library(dplyr)
library(here)
```

Cargar datos
```{r, message=FALSE}
url <- "https://raw.githubusercontent.com/alejandraandrea/slides-xaringan-mixed-models/master/dragons.tsv"
download.file(url, "dragons.tsv")
dragones <- read_tsv("dragons.tsv") #read_tsv de {readr}
```

```{r, message=FALSE}
here('dragones.csv')
```

---

## 2.2. Datos

Los datos contienen 480 observaciones contenidos en 4 columnas: testScore, bodyLenght, montainRange, site
```{r}
glimpse(dragones)
```

Antes de empezar cambiemos los nombres a espa침ol
```{r}
dragones<-dragones%>%
    rename(calificacion=testScore,
           tamanio = bodyLength,
           montania = mountainRange,
           sitio=site)
```

---

## 2.3. Preguntas

Imaginemos que: 
Se entrenaron a los dragones y se recopilaron datos de cada monta침a.

Entre mas r치pido aprendieron el entrenamiento mejor calificaci칩n, tambi칠n se midieron y se anoto en que sitio y en que regi칩n provienen.

쮸fectara el tama침o de los dragones a sus calificaciones?



---

## 2.4. Inspeccionar datos

```{r, eval=FALSE}
dragones %>% ggplot(aes(x=tamanio, 
             y=calificacion)) + 
             geom_jitter(alpha=.2)+
             theme_bw()
```


---

## 2.5 Ajustar modelo lineal
```{r}
library(broom)
```

Primero ajustar un modelo lineal
```{r}
ajuste_lm <- lm(calificacion ~ tamanio, data=dragones)
```

Estadisticos del modelo
```{r}
broom::tidy(ajuste_lm) %>% tibble::as_tibble()
```

Informaci칩n sobre el modelo
```{r}
glance(ajuste_lm) %>% tibble::as_tibble()
```

---

## 2.6. Ajustar modelo lineal

```{r}
info_ajuste_lm<-augment_columns(ajuste_lm, dragones)
```


```{r}
info_ajuste_lm %>% 
ggplot(aes(x=tamanio,y=calificacion))+ 
geom_jitter(alpha=.2)+
geom_line(aes(x=tamanio,y=.fitted))+
theme_bw()
```

---

## 2.7. Supuestos

Linealidad
```{r}
plot(ajuste_lm, which=1)
```

Normalidad
```{r}
plot(ajuste_lm, which=2)
```

Homocedasticidad
```{r}
plot(ajuste_lm, which=3)
```

---

## 2.8. Inspeccionar

```{r}
dragones %>%
  ggplot(aes(x=tamanio,y=calificacion, 
        colour=montania)) +
  geom_jitter(alpha=2) +
  theme_bw()
```

---

## 2.8. Inspeccionar

```{r}
dragones %>% 
  ggplot(aes(tamanio,calificacion,
      colour = montania))+
  geom_jitter(alpha=2) + 
  facet_wrap(~ montania) +
  theme_bw()+
  theme(strip.background=element_rect(fill="white"))
```

No se puede omitir la montania, pero como la incluimos?

---
name: random_effect

## 2.9. Efectos aleatorios

Paquetes
```{r}
#install.packages('broom.mixed')
#install.packages('lme4')
library(broom.mixed)
library(lme4)
```

Sintaxis de los efectos aleatorios (random effects)
```{r}
ajuste_lmer <- lmer(calificacion ~ tamanio + (1|montania), data = dragones)
```

```{r}
tidy(ajuste_lmer) %>% tibble::as_tibble()
```

```{r}
glance(ajuste_lmer) %>% tibble::as_tibble()
```

No hay valor p

---

## 2.9. Valor p

La libreria lmerTest te puede dar un valor p, pero regularmente hay que llevar los modelos mas alla. 

```{r}
library(lmerTest)
ajuste_lmer <- lmer(calificacion ~ tamanio + (1|montania), data = dragones)
tidy(ajuste_lmer) %>% tibble::as_tibble()
```

Que es un random effect y como saber cuando es [random o fijo](https://dynamicecology.wordpress.com/2015/11/04/is-it-a-fixed-or-random-effect/)

---

## 2.10. Inspeccionar

Informacion de el ajuste: valores ajustados (.fitted), residuales (.resid)
```{r}
info_ajuste_lmer<- augment_columns(ajuste_lmer,dragones)
```

Las montanias parecen tener un efecto en la calificacion.
```{r}
info_ajuste_lmer %>% 
 ggplot(aes(x=tamanio,y=calificacion, colour=montania))+ 
 geom_jitter(alpha=2)+ 
 facet_wrap(~ montania)+
 geom_line(aes(x=tamanio,y=.fitted),
 colour="black")+
theme_bw()
```

---

## 2.11. Supuestos

```{r}
plot(ajuste_lmer)
```

```{r}
qqnorm(resid(ajuste_lmer))
qqline(resid(ajuste_lmer))
```

```{r}
summary(ajuste_lmer)
```

Aqui se ve claramente que la varianza de el sistema montanioso es 339.7.
Entonces las montanias son claramente importantes porque explican mucha de la variacion. Como saber cuanto explican de la variacion? Se puede tomar la varianza de la montania y dividirla por el total de la varianza. 

```{r}
339.7/(339.7 + 223.8)
```


---
name: AIC

# 3. AIC

---

## 3.1. AIC

El AIC (Akaike Information criterion) es un modelo matermatico para evaluar que tan bien se ajusta el modelo a los datos generados. En estadistica se usa mucho para comparar dos modelos posibles y determinar cual es el mejor modelo.

AIC se calcula de:
- el numero de variables independientes que se uso para construir el modelo
- el estimado de maximum likelihood (que tan bien el modelo reproduce los datos)

El mejor modelo se identifica a partir de un AIC, que explica la mayor cantidad de variacion usando el menos numero de variables independientes. 


----

## 3.2. Dragones

Usando el ejemplo de dragones, que modelo se ajusta mejor a nuestros datos?
A lo mejor colectamos variables que no son importantes para nuestro modelo.

Los menos AIC son mejores, y AIC penaliza los modelos que usen mas par치metros.

---
name: nested_effects

## 3.1. Efectos aleatorios anidados

La variable de sitio es un factor con tres niveles: un sitio a, b y c. Y existe un anidamiento (nesting) del sitio con la monta침a. Entonces los sitios no tienen significado si no le asignamos las monta침as. Para no tener que estar recordando que esto ocurre, lo mejor es crear una nueva variable anidada (nested)

```{r}
dragones$muestra <- factor(paste0(dragones$montania,dragones$sitio))
```

Recordando, el factor aleatorio solo aparece en un nivel en particular. Por eso es anidado, cada sitio pertenece a un sistema monta침oso en especial y solo en ese sistema. Para efectos cruzados es cuando el factor aparece en mas de un nivel en otros factores, por ejemplo si el mismo drag칩n aparece en mas de un sistema monta침oso. 

---

## 3.2. Factores aleatorios

De acuerdo a lo que vimos anteriormente, entonces no podemos poner los efectos aleatorios separados.
```{r}
modelo_incorrecto <- lmer(calificacion ~ tamanio + 
                      (1|montania) + (1|sitio), data = dragones)  
```
Este modelo trata los efectos aleatorios como cruzados.


---

## 3.3. Modelo completo

Con los datos de dragones una manera de crear un modelo completo seria la siguiente.
```{r}
lmer_completo <- lmer(calificacion ~ tamanio + (1|montania) + (1|muestra), 
				  data = dragones, REML = FALSE)
```

```{r}
lmer_completo
```

---


## 3.4. Como se reporta eso?

De mejor a peor lo que podemos hacer es usar:

- Z-test de Wald 
- t-test de Wald (en este modelo los valores tendrian que estar balanceados)
- Prueba de raz칩n de verosimilitud (en ingl칠s: Likelihood ratio tests). Usando anova() o drop1())
- Markov chain Monte Carlo (MCMC) o un bootstramp parametrico con intervalos de confianza

---


## 3.5. Compara modelos

Modelo completo.
```{r}
lmer_completo <- lmer(calificacion ~ tamanio + (1|montania) + (1|muestra), 
				  data = dragones, REML = FALSE)
```

Modelo reducido. **Nota** que no incluye tama침o.
```{r}
lmer_reducido <- lmer(calificacion ~ 1 + (1|montania) + (1|muestra), 
					     data = dragones, REML = FALSE)
```

Comparaci칩n de los modelos.
```{r}
anova(lmer_reducido, lmer_completo)  # the two models are not significantly different
```

---

# 3.6. mas factores

Generar valores aleatorios
```{r}
set.seed(1234)
edad<-runif(480, min=0, max=100)
set.seed(1234)
fuego<-runif(480, min=0, max=15)
```

Agregar como variables
```{r}
dragones$edad<-edad
dragones$fuego<-fuego
```

---

# 3.7. drop1

```{r}
lmer_completo <- lmer(calificacion ~ tamanio + edad + fuego +
                        (1|montania) + (1|muestra), 
				  data = dragones, REML = FALSE)
```

```{r}
drop1(lmer_completo, test="F")
```


---

### 3.3. Comparar muchos modelos

Cargar paquetes
```{r}
library(lme4)
library(MuMIn)
```

Primer modelo
```{r}
mod1 <- lmer(calificacion ~ tamanio + (1|montania) + (1|muestra), 
				  data = dragones, REML = FALSE)
```

Segundo modelo
```{r}
mod2 <- lmer(calificacion ~ tamanio + fuego + (1|montania) + (1|muestra), 
					     data = dragones, REML = FALSE)
```

Tercer modelo
```{r}
mod3 <- lmer(calificacion ~ tamanio + fuego + edad + (1|montania) + (1|muestra),data = dragones, REML = FALSE)
```

---

### 3.4. Comparar muchos modelos

```{r}
library(MuMIn)
options(na.action = "na.fail")
```

```{r}
lmer_completo <- lmer(calificacion ~ tamanio +
                        (1|montania) + (1|muestra), 
				  data = dragones, REML = FALSE)
```

AICs, delta y pesos (weight)
```{r}
dredge(lmer_completo)
```


---

# 4. Para considerar

- [Usar Machine learning](https://github.com/m-clark/introduction-to-machine-learning)

- [Usar Estadistica bayesiana](https://oliviergimenez.github.io/blog/bayesworkshop/)

Otras lecturas:
- [El reinado de los valores p se ha terminado, ahora que hacemos?](https://royalsocietypublishing.org/doi/10.1098/rsbl.2019.0174)


---

class: left, inverse

# Contacto

Recapitulando

- [Reproducibilidad](#repro)
- [Publicaciones reproducibles](#pub)
- [Manuscritos reproducibles](#MS)

<br>
<br>

Para dudas, comentarios y sugerencias:  
- Escr칤beme a miriamjlerma@gmail.com

<br>
<br>

.right[Este material esta accesible y se encuentra en <br>
mi [`r fa("external-link-alt", fill = '#74c69d')`github](https://github.com/MiriamLL/Curso_CIAD/)
y mi [`r fa("external-link-alt", fill = '#74c69d')`p치gina](https://miriamlerma.netlify.app/materiales.html)


.center[
```{r, echo=FALSE}
library(fontawesome)
```
<h3>`r fa("home", fill = "#74c69d")`[Volver ](https://miriamlerma.netlify.app/materiales.html)
]]

